<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>유튜브 수익 대시보드</title>
  <link rel="stylesheet" href="style.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1>📊 유튜브 수익 대시보드</h1>
      <p class="subtitle">실시간 채널 수익 모니터링</p>
    </header>

    <!-- 탭 -->
    <div class="tabs">
      <button class="tab-btn active" id="tabDashboard" onclick="switchTab('dashboard')">대시보드</button>
      <button class="tab-btn" id="tabManage" onclick="switchTab('manage')">채널 관리</button>
      <button class="tab-btn" id="tabTasks" onclick="switchTab('tasks')">할 일</button>
    </div>

    <!-- 건강도 배너 -->
    <div id="healthBanner" class="health-banner hidden"></div>

    <!-- ========================= 대시보드 ========================= -->
    <section id="dashboardSection">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">총 수익 (이번 달)</div>
          <div class="stat-value" id="totalRevenue">₩0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">총 조회수</div>
          <div class="stat-value" id="totalViews">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">평균 RPM</div>
          <div class="stat-value" id="avgRpm">₩0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">활성 채널</div>
          <div class="stat-value" id="activeChannels">0</div>
        </div>
      </div>

      <div class="channel-stats">
        <h2>채널별 통계</h2>
        <div id="channelCards" class="channel-grid"></div>
      </div>

      <div class="charts-container">
        <div class="chart-box">
          <h2>일별 수익 추이</h2>
          <canvas id="revenueChart"></canvas>
        </div>
        <div class="chart-box">
          <h2>채널별 비교</h2>
          <canvas id="channelComparisonChart"></canvas>
        </div>
        <div class="chart-box">
          <h2>RPM 추이</h2>
          <canvas id="rpmChart"></canvas>
        </div>
      </div>

      <div class="table-container">
        <h2>최근 데이터</h2>
        <div class="table-controls">
          <button id="refreshBtn" onclick="loadData()">🔄 새로고침</button>
          <select id="channelFilter" onchange="filterData()">
            <option value="all">전체 채널</option>
          </select>
        </div>
        <table id="dataTable">
          <thead>
          <tr>
            <th>날짜</th>
            <th>채널명</th>
            <th>조회수</th>
            <th>수익</th>
            <th>RPM</th>
          </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </section>

    <!-- ========================= 채널 관리 ========================= -->
    <section id="manageSection" class="hidden">
      <div class="manage-header">
        <h2>채널 관리</h2>
        <div class="manage-actions">
          <input id="manageSearch" class="input" placeholder="검색: 채널명/주제/전략/메모" oninput="applyManageFilters()" />
          <select id="statusFilter" class="select" onchange="applyManageFilters()">
            <option value="all">수창 상태: 전체</option>
            <option value="ON">ON</option>
            <option value="OFF">OFF</option>
            <option value="심사중">심사중</option>
            <option value="제한">제한</option>
          </select>
          <select id="topicFilter" class="select" onchange="applyManageFilters()">
            <option value="all">주제(니치): 전체</option>
          </select>
          <a id="openSheetBtn" class="btn" target="_blank" rel="noopener">시트에서 편집</a>
        </div>
      </div>

      <div class="manage-layout">
        <div class="manage-table-wrap">
          <table class="manage-table">
            <thead>
              <tr>
                <th>채널명</th>
                <th>주제</th>
                <th>수창 상태</th>
                <th>계정 이메일</th>
                <th>원본 소스</th>
                <th>담당자</th>
              </tr>
            </thead>
            <tbody id="manageTbody"></tbody>
          </table>
          <p class="hint">행을 클릭하면 상세가 열립니다.</p>
        </div>

        <aside id="manageDetail" class="manage-detail hidden">
          <div class="detail-header">
            <div>
              <div class="detail-title" id="detailChannelName">-</div>
              <div class="detail-sub" id="detailChannelId">-</div>
            </div>
            <button class="icon-btn" onclick="closeDetail()">닫기</button>
          </div>

          <div class="detail-badges">
            <span id="detailStatusBadge" class="badge">-</span>
            <span id="detailTopic" class="chip">-</span>
          </div>

          <div class="detail-block">
            <div class="detail-label">전략</div>
            <div id="detailStrategy" class="detail-text">-</div>
          </div>

          <div class="detail-block">
            <div class="detail-label">메모</div>
            <div id="detailMemo" class="detail-text">-</div>
          </div>

          <div class="detail-block">
            <div class="detail-label">최근 7일 요약(일별데이터 기준)</div>
            <div class="kpi-grid">
              <div class="kpi">
                <div class="kpi-label">조회수</div>
                <div class="kpi-value" id="kpi7Views">-</div>
              </div>
              <div class="kpi">
                <div class="kpi-label">수익</div>
                <div class="kpi-value" id="kpi7Revenue">-</div>
              </div>
              <div class="kpi">
                <div class="kpi-label">평균 RPM</div>
                <div class="kpi-value" id="kpi7Rpm">-</div>
              </div>
            </div>
          </div>

          <div class="detail-block">
            <div class="detail-label">연결</div>
            <div class="detail-links">
              <span class="muted">원본 소스:</span> <span id="detailSource">-</span><br/>
              <span class="muted">이메일:</span> <span id="detailEmail">-</span><br/>
              <span class="muted">담당자:</span> <span id="detailOwner">-</span>
            </div>
          </div>
        </aside>
      </div>
    </section>

    <!-- ========================= 할 일 ========================= -->
    <section id="tasksSection" class="hidden">
      <div class="manage-header">
        <h2>할 일</h2>

        <div class="manage-actions">
          <input id="adminPassInput" class="input" type="password" placeholder="관리자 비밀번호(세션)" />
          <button class="btn" onclick="setAdminPass()">관리자 모드</button>
          <button class="btn" onclick="logoutAdmin()">로그아웃</button>
          <button class="btn" onclick="loadTasks()">새로고침</button>
        </div>
      </div>

      <div class="tasks-toolbar">
        <select id="taskCategory" class="select" onchange="renderTasks()">
          <option value="all">카테고리: 전체</option>
          <option value="업무">업무</option>
          <option value="개인">개인</option>
        </select>

        <select id="taskStatus" class="select" onchange="renderTasks()">
          <option value="all">상태: 전체</option>
          <option value="TODO">TODO</option>
          <option value="DOING">DOING</option>
          <option value="DONE">DONE</option>
          <option value="HOLD">HOLD</option>
        </select>

        <select id="taskPriority" class="select" onchange="renderTasks()">
          <option value="all">우선순위: 전체</option>
          <option value="P0">P0</option>
          <option value="P1">P1</option>
          <option value="P2">P2</option>
        </select>

        <input id="taskSearch" class="input" placeholder="검색: 제목/메모/태그" oninput="renderTasks()" />
      </div>

      <div class="tasks-panels">
        <div class="panel">
          <h3>오늘/지연</h3>
          <div id="todayTasks" class="task-list"></div>
        </div>

        <div class="panel">
          <div class="panel-head">
            <h3>전체 할 일</h3>
            <button class="btn primary" id="btnOpenCreate" onclick="toggleCreateForm(true)">+ 할 일 추가</button>
          </div>

          <div id="createForm" class="create-form hidden">
            <div class="form-grid">
              <select id="newCategory" class="select" onchange="onCategoryChange()">
                <option value="업무">업무</option>
                <option value="개인">개인</option>
              </select>

              <input id="newTitle" class="input" placeholder="제목(필수)" />

              <select id="newPriority" class="select">
                <option value="P1" selected>P1</option>
                <option value="P0">P0</option>
                <option value="P2">P2</option>
              </select>

              <input id="newDue" class="input" type="date" />

              <select id="newScope" class="select" onchange="onScopeChange()">
                <option value="ALL">업무: 전체</option>
                <option value="CHANNEL">업무: 특정 채널</option>
                <option value="PERSONAL">개인</option>
              </select>

              <select id="newChannelId" class="select" disabled>
                <option value="">(채널 선택)</option>
              </select>

              <input id="newTags" class="input" placeholder="태그(쉼표, 선택)" />
              <input id="newMemo" class="input" placeholder="메모(선택)" />
            </div>

            <div class="form-actions">
              <button class="btn" onclick="toggleCreateForm(false)">닫기</button>
              <button class="btn primary" onclick="createTask()">저장</button>
            </div>
            <p class="hint">관리자 모드(세션)가 켜져 있어야 저장됩니다.</p>
          </div>

          <table class="manage-table">
            <thead>
              <tr>
                <th>완료</th>
                <th>카테고리</th>
                <th>제목</th>
                <th>상태</th>
                <th>우선순위</th>
                <th>마감일</th>
                <th>채널</th>
                <th>태그</th>
                <th>관리</th>
              </tr>
            </thead>
            <tbody id="tasksTbody"></tbody>
          </table>
        </div>
      </div>

      <!-- ===== 할 일 편집 모달 (패널 밖, tasksSection 하단에 두는게 안전) ===== -->
      <div id="editModal" class="modal hidden">
        <div class="modal-backdrop" onclick="closeEditModal()"></div>

        <div class="modal-card">
          <div class="modal-header">
            <div class="modal-title">할 일 편집</div>
            <button class="icon-btn" onclick="closeEditModal()">닫기</button>
          </div>

          <div class="modal-body">
            <input id="editTaskId" type="hidden" />

            <div class="form-grid">
              <label class="field">
                <span class="field-label">제목</span>
                <input id="editTitle" class="input" placeholder="제목(필수)" />
              </label>

              <label class="field">
                <span class="field-label">마감일</span>
                <input id="editDue" class="input" type="date" />
              </label>

              <label class="field">
                <span class="field-label">태그</span>
                <input id="editTags" class="input" placeholder="태그(쉼표, 선택)" />
              </label>

              <label class="field">
                <span class="field-label">메모</span>
                <input id="editMemo" class="input" placeholder="메모(선택)" />
              </label>
            </div>
          </div>

          <div class="modal-actions">
            <button class="btn" onclick="closeEditModal()">취소</button>
            <button class="btn danger" onclick="deleteTaskFromModal()">삭제</button>
            <button class="btn primary" onclick="saveEditModal()">저장</button>
          </div>

          <p class="hint">삭제는 숨김 처리(status=DELETED)로 반영됩니다.</p>
        </div>
      </div>
    </section>

    <footer>
      <p>마지막 업데이트: <span id="lastUpdate">-</span></p>
    </footer>
  </div>

  <script src="app.js"></script>
</body>
</html>
